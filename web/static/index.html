<!DOCTYPE html>
<html>
<head>
    <title>Pizarra Digital v2.1</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #000; overflow: hidden; touch-action: none; font-family: sans-serif; }
        
        #container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: #121212; position: relative;
        }

        #loadingText {
            position: absolute; color: #666; font-size: 14px; letter-spacing: 1px; z-index: 0;
            text-align: center; width: 100%; pointer-events: none;
        }

        #zoomLayer {
            position: relative; transform-origin: 0 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            width: fit-content; height: fit-content;
            display: flex;
        }

        #stream {
            display: none; max-width: 100vw; max-height: 100vh;
            width: auto; height: auto; object-fit: contain; pointer-events: none;
        }

        #drawCanvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; touch-action: none;
        }

        .frozen { border: 3px solid #00bcd4; box-sizing: border-box; }

        /* --- TOOLBOX COMPACTO --- */
        #toolbox {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(30,30,30,0.95); padding: 4px;
            border-radius: 6px; border: 1px solid #444;
            display: flex; flex-direction: column; gap: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .row { display: flex; gap: 4px; align-items: center; }
        .sep { width: 1px; height: 20px; background: #555; margin: 0 1px; }

        #extendedTools { display: none; gap: 4px; align-items: center; }
        
        /* BOTONES M√ÅS PEQUE√ëOS */
        button {
            width: 30px; height: 30px; border: 1px solid #444; background: #2a2a2a; color: #ccc;
            border-radius: 4px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            padding: 0; transition: background 0.2s;
        }
        button:active { background: #111; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        button svg { fill: #ccc; width: 16px; height: 16px; }
        
        #toggleBtn { font-weight: bold; font-family: monospace; font-size: 12px; }

        /* ESTADOS ACTIVOS */
        .active-safe { background: #1e7e34 !important; border-color: #155724 !important; color: white !important; }
        .active-tool { background: #0069d9 !important; border-color: #0056b3 !important; color: white !important; }
        .active-eraser { background: #c82333 !important; border-color: #bd2130 !important; color: white !important; }

        /* SELECTOR COLOR COMPACTO */
        .color-box { position: relative; width: 30px; height: 30px; border: 1px solid #444; background: #2a2a2a; border-radius: 4px; overflow: hidden; }
        #colorInput { position: absolute; width: 150%; height: 150%; top: -25%; left: -25%; cursor: pointer; opacity: 0; }
        #colorDot { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #fff; pointer-events: none; margin: 6px; }

        #sliderPanel { display: none; padding: 0 5px; background: rgba(0,0,0,0.3); border-radius: 4px; height: 30px; align-items: center; }
        input[type=range] { width: 80px; cursor: pointer; height: 4px; }

        /* MENU DESPLEGABLE */
        #menuDrop {
            position: absolute; top: 100%; right: 0; margin-top: 4px;
            background: #222; border: 1px solid #444; border-radius: 4px;
            display: none; flex-direction: column; width: 150px;
        }
        #menuDrop.show { display: flex; }
        .menu-btn { width: 100%; border: none; background: transparent; justify-content: flex-start; padding: 8px; font-size: 13px; gap: 8px; border-bottom: 1px solid #333; border-radius: 0; height: auto; }
        .menu-btn:hover { background: #333; }

        #ghost {
            position: fixed; pointer-events: none; z-index: 2000;
            border: 1px solid rgba(255,255,255,0.8); border-radius: 50%; 
            display: none; transform: translate(-50%, -50%); box-shadow: 0 0 2px black;
        }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            z-index: 4000; display: none; align-items: center; justify-content: center;
        }
        .modal-content { background: #222; padding: 20px; border-radius: 8px; border: 1px solid #555; color: #fff; text-align: center; min-width: 220px; }
        .modal-btns { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        .btn-sm { width: auto; padding: 6px 15px; font-size: 13px; font-weight: bold; height: 28px; }
        .auth-input { width: 100%; padding: 8px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; font-size: 16px; text-align: center; border-radius: 4px; letter-spacing: 3px; box-sizing: border-box; }
        .auth-input:focus { outline: none; border-color: #007bff; }

        /* SERVER CONTROLS (SUPER COMPACTO) */
        #serverControls {
            display: none; position: absolute; top: 10px; right: 10px; z-index: 5000;
        }
        #serverPauseBtn {
            width: 34px; height: 34px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.3);
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); font-size: 0; /* Hide text */
            background: #28a745; position: relative;
        }
        /* Icono "REC" o Estado */
        #serverPauseBtn::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; background: white; border-radius: 50%;
        }
        /* Estado Pausado (Rojo y Cuadrado Stop) */
        #serverPauseBtn.is-paused { background: #dc3545; }
        #serverPauseBtn.is-paused::after { border-radius: 2px; width: 10px; height: 10px; }

        /* Efecto pulsaci√≥n para EN VIVO */
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
        #serverPauseBtn.is-live { animation: pulse 2s infinite; }
    </style>
</head>
<body>
    <div id="ghost"></div>
    
    <div id="modalClear" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size:14px; margin-bottom:10px;">¬øBorrar todo?</div>
            <div class="modal-btns">
                <button class="btn-sm" onclick="closeModal('modalClear')">NO</button>
                <button class="btn-sm" onclick="confirmClear()" style="background:#c82333;border:none;">S√ç</button>
            </div>
        </div>
    </div>

    <div id="modalAuth" class="modal-overlay">
        <div class="modal-content">
            <h4 style="margin:0 0 10px 0; color:#ccc;">Modo Profesor</h4>
            <input type="password" id="pinInput" class="auth-input" placeholder="PIN" maxlength="8">
            <div class="modal-btns">
                <button class="btn-sm" onclick="closeModal('modalAuth')">Cancelar</button>
                <button class="btn-sm" onclick="authSubmit()" style="background:#0069d9; border:none;">Entrar</button>
            </div>
        </div>
    </div>

    <div id="container">
        <div id="loadingText">CONECTANDO...</div>
        <div id="zoomLayer">
            <img id="stream" alt="">
            <canvas id="drawCanvas"></canvas>
        </div>
    </div>

    <div id="serverControls">
        <button id="serverPauseBtn" class="is-live" title="Control Transmisi√≥n"></button>
    </div>

    <div id="toolbox">
        <div style="text-align:center; color:#555; font-size:8px; cursor:grab; padding-bottom:2px;" id="handle">:::</div>
        <div class="row">
            <button id="viewBtn" title="Ver">üëÅÔ∏è</button>
            <button id="handBtn" title="Mover">‚úã</button>
            <button id="toggleBtn" title="M√°s">></button>

            <div id="extendedTools">
                <div class="sep"></div>
                <button id="pencilBtn" title="L√°piz">‚úèÔ∏è</button>
                <button id="eraserBtn" title="Goma">üßº</button>
                <div class="color-box">
                    <div id="colorDot" style="background:red;"></div>
                    <input type="color" id="colorInput" value="#ff0000">
                </div>
                <div class="sep"></div>
                <button id="undoBtn" disabled>‚Ü©Ô∏è</button>
                <button id="redoBtn" disabled>‚Ü™Ô∏è</button>
                <button id="menuBtn">‚ãÆ</button>
                
                <div id="menuDrop">
                    <button class="menu-btn" id="freezeBtn"><span>‚ùÑÔ∏è</span> Congelar (M√≠)</button>
                    <button class="menu-btn" id="snapBtn"><span>üì∏</span> Foto</button>
                    <button class="menu-btn" id="fullBtn">
                        <!-- SVG Pantalla Completa -->
                        <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                        Pantalla Completa
                    </button>
                    <button class="menu-btn" onclick="openModal('modalClear')" style="color:#ff6b6b"><span>üóëÔ∏è</span> Borrar Todo</button>
                    <div style="height:1px; background:#444; margin:5px 0;"></div>
                    <button class="menu-btn" onclick="openAuthModal()" style="color:#17a2b8"><span>üéì</span> Profesor</button>
                </div>
            </div>
        </div>
        <div class="row" id="sliderPanel">
            <input type="range" id="sizeSlider" min="1" max="50" value="3">
        </div>
    </div>

    <script>
        const container = document.getElementById('container');
        const zoomLayer = document.getElementById('zoomLayer');
        const stream = document.getElementById('stream');
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const ghost = document.getElementById('ghost');
        const loadingText = document.getElementById('loadingText');
        
        let currentTool = 'view', isLocalFrozen = false, isAdmin = false, color = '#ff0000', brushSize = 3, transform = {x:0,y:0,scale:1}, history = [], historyHead = -1, isExpanded = false;
        let objUrl = null;
        const ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/stream');
        
        ws.onopen = () => loadingText.innerText = "";
        ws.onclose = () => { loadingText.innerText = "OFFLINE"; loadingText.style.display='block'; };

        ws.onmessage = (e) => {
            if (e.data instanceof Blob) {
                if (isLocalFrozen) return;
                if (objUrl) URL.revokeObjectURL(objUrl);
                objUrl = URL.createObjectURL(e.data);
                stream.src = objUrl;
                if(stream.style.display !== 'block') { stream.style.display = 'block'; loadingText.style.display = 'none'; }
                return;
            }
            try {
                const msg = JSON.parse(e.data);
                if (msg.type === 'AUTH_OK') {
                    isAdmin = true;
                    document.getElementById('serverControls').style.display = 'block';
                    updateServerUI(msg.paused);
                } else if (msg.type === 'AUTH_FAIL') {
                    document.getElementById('pinInput').value = '';
                    alert("PIN Error");
                } else if (msg.type === 'STATUS') {
                    updateServerUI(msg.paused);
                }
            } catch (err) {}
        };

        function openAuthModal() {
            document.getElementById('menuDrop').classList.remove('show');
            document.getElementById('modalAuth').style.display = 'flex';
            document.getElementById('pinInput').focus();
        }
        function authSubmit() {
            ws.send(JSON.stringify({ type: 'AUTH', payload: document.getElementById('pinInput').value }));
            document.getElementById('pinInput').value = '';
            closeModal('modalAuth');
        }
        document.getElementById('pinInput').addEventListener("keypress", e => { if (e.key === "Enter") authSubmit(); });

        const sBtn = document.getElementById('serverPauseBtn');
        function updateServerUI(paused) {
            if (paused) {
                sBtn.className = 'is-paused';
                sBtn.title = "EN PAUSA (Privado)";
                if (!isAdmin) { loadingText.innerText = "‚è∏Ô∏è PAUSA"; loadingText.style.display = 'block'; loadingText.style.background = "rgba(0,0,0,0.5)"; }
            } else {
                sBtn.className = 'is-live';
                sBtn.title = "EN VIVO";
                if (!isAdmin) loadingText.style.display = 'none';
            }
        }
        sBtn.onclick = () => {
            if (!isAdmin) return;
            const isLive = sBtn.classList.contains('is-live');
            ws.send(JSON.stringify({ type: 'CMD', payload: isLive ? 'PAUSE' : 'RESUME' }));
        };

        const toggleBtn = document.getElementById('toggleBtn'), extendedTools = document.getElementById('extendedTools');
        toggleBtn.onclick = () => {
            isExpanded = !isExpanded;
            extendedTools.style.display = isExpanded ? 'flex' : 'none';
            toggleBtn.innerText = isExpanded ? '<' : '>';
            if (!isExpanded) { if(currentTool==='pencil'||currentTool==='eraser') setTool('view'); document.getElementById('menuDrop').classList.remove('show'); }
        };

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('#toolbox button').forEach(b => b.classList.remove('active-safe', 'active-tool', 'active-eraser'));
            document.getElementById('sliderPanel').style.display = 'none';
            document.getElementById('menuDrop').classList.remove('show');
            ghost.style.display = 'none';
            if (tool === 'view') {
                document.getElementById('viewBtn').classList.add('active-safe');
                canvas.style.pointerEvents = 'none'; container.style.cursor = 'default';
            } else if (tool === 'hand') {
                document.getElementById('handBtn').classList.add('active-tool');
                canvas.style.pointerEvents = 'none'; container.style.cursor = 'grab';
            } else {
                if (tool === 'pencil') { document.getElementById('pencilBtn').classList.add('active-tool'); ctx.globalCompositeOperation = 'source-over'; }
                else { document.getElementById('eraserBtn').classList.add('active-eraser'); ctx.globalCompositeOperation = 'destination-out'; }
                ctx.strokeStyle = color; canvas.style.pointerEvents = 'auto';
                document.getElementById('sliderPanel').style.display = 'flex'; container.style.cursor = 'none'; updateContext();
            }
        }

        document.getElementById('viewBtn').onclick = () => setTool('view');
        document.getElementById('handBtn').onclick = () => setTool('hand');
        document.getElementById('pencilBtn').onclick = () => setTool('pencil');
        document.getElementById('eraserBtn').onclick = () => setTool('eraser');
        document.getElementById('menuBtn').onclick = (e) => { e.stopPropagation(); document.getElementById('menuDrop').classList.toggle('show'); };
        document.getElementById('colorInput').oninput = (e) => { color = e.target.value; document.getElementById('colorDot').style.background = color; if(currentTool==='pencil') updateContext(); };
        document.getElementById('sizeSlider').oninput = (e) => { brushSize = parseInt(e.target.value); updateContext(); if(currentTool==='pencil'||currentTool==='eraser') showGhost(lastX, lastY); };

        function updateContext() { ctx.lineWidth = brushSize; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = color; }

        document.getElementById('freezeBtn').onclick = () => {
            isLocalFrozen = !isLocalFrozen;
            const btn = document.getElementById('freezeBtn');
            if (isLocalFrozen) { stream.classList.add('frozen'); btn.innerHTML = '<span style="color:#00bcd4">‚ñ∂Ô∏è</span> Reanudar'; }
            else { stream.classList.remove('frozen'); btn.innerHTML = '<span>‚ùÑÔ∏è</span> Congelar (M√≠)'; }
            document.getElementById('menuDrop').classList.remove('show');
        };

        document.getElementById('snapBtn').onclick = () => {
            const t = document.createElement('canvas'); t.width = stream.naturalWidth; t.height = stream.naturalHeight;
            const tc = t.getContext('2d'); tc.drawImage(stream,0,0); tc.drawImage(canvas,0,0);
            const a = document.createElement('a'); a.download = 'pizarra-'+Date.now()+'.png'; a.href = t.toDataURL(); a.click();
            document.getElementById('menuDrop').classList.remove('show');
        };

        document.getElementById('fullBtn').onclick = () => {
            if (!document.fullscreenElement) document.body.requestFullscreen(); else document.exitFullscreen();
            document.getElementById('menuDrop').classList.remove('show');
        };

        function updateTransform() { zoomLayer.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`; }
        let isDragging = false, startX = 0, startY = 0, initialDist = 0, initialScale = 1;

        container.addEventListener('mousedown', e => { if(currentTool!=='hand')return; isDragging=true; startX=e.clientX-transform.x; startY=e.clientY-transform.y; container.style.cursor='grabbing'; });
        window.addEventListener('mousemove', e => { if(isDragging&&currentTool==='hand'){ e.preventDefault(); transform.x=e.clientX-startX; transform.y=e.clientY-startY; updateTransform(); } if(currentTool==='pencil'||currentTool==='eraser') showGhost(e.clientX,e.clientY); });
        window.addEventListener('mouseup', () => { isDragging=false; if(currentTool==='hand') container.style.cursor='grab'; });

        container.addEventListener('touchstart', e => {
            if(currentTool!=='hand')return;
            if(e.touches.length===1){ isDragging=true; startX=e.touches[0].clientX-transform.x; startY=e.touches[0].clientY-transform.y; }
            else if(e.touches.length===2){ isDragging=false; initialDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); initialScale=transform.scale; }
        }, {passive:false});
        container.addEventListener('touchmove', e => {
            if(currentTool!=='hand')return; e.preventDefault();
            if(e.touches.length===1&&isDragging){ transform.x=e.touches[0].clientX-startX; transform.y=e.touches[0].clientY-startY; updateTransform(); }
            else if(e.touches.length===2&&initialDist>0){
                const d = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
                const s = Math.min(Math.max(0.5, initialScale*(d/initialDist)), 10);
                const mx = (e.touches[0].clientX+e.touches[1].clientX)/2, my = (e.touches[0].clientY+e.touches[1].clientY)/2;
                transform.x=mx-(mx-transform.x)*(s/transform.scale); transform.y=my-(my-transform.y)*(s/transform.scale); transform.scale=s; updateTransform();
            }
        }, {passive:false});
        container.addEventListener('touchend', () => { isDragging=false; initialDist=0; });
        container.addEventListener('wheel', e => {
            if(currentTool!=='hand')return; e.preventDefault();
            const s = Math.min(Math.max(0.5, transform.scale*(e.deltaY>0?0.9:1.1)), 10);
            transform.x=e.clientX-(e.clientX-transform.x)*(s/transform.scale); transform.y=e.clientY-(e.clientY-transform.y)*(s/transform.scale); transform.scale=s; updateTransform();
        }, {passive:false});

        let isDraw = false, lastX = 0, lastY = 0;
        function getPos(cx,cy) { const r=canvas.getBoundingClientRect(); return {x:(cx-r.left)*(canvas.width/r.width), y:(cy-r.top)*(canvas.height/r.height)}; }
        function startD(e) { if(currentTool!=='pencil'&&currentTool!=='eraser')return; const cx=e.touches?e.touches[0].clientX:e.clientX, cy=e.touches?e.touches[0].clientY:e.clientY; isDraw=true; ctx.beginPath(); const p=getPos(cx,cy); ctx.moveTo(p.x,p.y); lastX=cx; lastY=cy; showGhost(cx,cy); }
        function moveD(e) { if(!isDraw)return; e.preventDefault(); const cx=e.touches?e.touches[0].clientX:e.clientX, cy=e.touches?e.touches[0].clientY:e.clientY; const p=getPos(cx,cy); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=cx; lastY=cy; showGhost(cx,cy); }
        function endD() { if(isDraw){ isDraw=false; ctx.closePath(); saveHist(); } }
        canvas.addEventListener('mousedown', startD); canvas.addEventListener('touchstart', startD, {passive:false});
        window.addEventListener('mousemove', e => { if(isDraw) moveD(e); }); window.addEventListener('touchmove', e => { if(isDraw) moveD(e); }, {passive:false});
        window.addEventListener('mouseup', endD); window.addEventListener('touchend', endD);
        
        function showGhost(cx, cy) { ghost.style.display='block'; const s=brushSize*transform.scale; ghost.style.width=s+'px'; ghost.style.height=s+'px'; ghost.style.left=cx+'px'; ghost.style.top=cy+'px'; }

        function saveHist() { if(historyHead<history.length-1) history.length=historyHead+1; history.push(canvas.toDataURL()); if(history.length>15) history.shift(); else historyHead++; updateBtns(); }
        function updateBtns() { document.getElementById('undoBtn').disabled = historyHead<0; document.getElementById('redoBtn').disabled = historyHead>=history.length-1; }
        document.getElementById('undoBtn').onclick=()=>{if(historyHead>=0){historyHead--;loadH();}else{ctx.clearRect(0,0,canvas.width,canvas.height);historyHead=-1;updateBtns();}};
        document.getElementById('redoBtn').onclick=()=>{if(historyHead<history.length-1){historyHead++;loadH();}};
        function loadH(){if(historyHead===-1){ctx.clearRect(0,0,canvas.width,canvas.height);updateBtns();return;}const i=new Image();i.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);const p=ctx.globalCompositeOperation;ctx.globalCompositeOperation='source-over';ctx.drawImage(i,0,0);ctx.globalCompositeOperation=p;};i.src=history[historyHead];updateBtns();}

        function openModal(id) { document.getElementById(id).style.display = 'flex'; document.getElementById('menuDrop').classList.remove('show'); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function confirmClear() { ctx.clearRect(0,0,canvas.width,canvas.height); saveHist(); closeModal('modalClear'); }

        const handle = document.getElementById('handle'), box = document.getElementById('toolbox');
        let dOff={x:0,y:0}, isBox=false;
        handle.addEventListener('mousedown', e=>{isBox=true;dOff.x=e.clientX-box.offsetLeft;dOff.y=e.clientY-box.offsetTop;}); handle.addEventListener('touchstart', e=>{isBox=true;dOff.x=e.touches[0].clientX-box.offsetLeft;dOff.y=e.touches[0].clientY-box.offsetTop;},{passive:false});
        window.addEventListener('mousemove', e=>{if(isBox){box.style.left=(e.clientX-dOff.x)+'px';box.style.top=(e.clientY-dOff.y)+'px';}}); window.addEventListener('touchmove', e=>{if(isBox){e.preventDefault();box.style.left=(e.touches[0].clientX-dOff.x)+'px';box.style.top=(e.touches[0].clientY-dOff.y)+'px';}},{passive:false});
        window.addEventListener('mouseup', ()=>isBox=false); window.addEventListener('touchend', ()=>isBox=false);

        function resize() { if(stream.naturalWidth&&canvas.width!==stream.naturalWidth){ const s=canvas.toDataURL(); canvas.width=stream.naturalWidth; canvas.height=stream.naturalHeight; const i=new Image(); i.onload=()=>{ctx.drawImage(i,0,0);updateContext();}; i.src=s; } }
        stream.onload=resize; window.onresize=resize;
        setTool('view');
    </script>
</body>
</html>
